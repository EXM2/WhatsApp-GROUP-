<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>قروبات واتساب - دليل شامل ذكي</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
  --primary: #25d366;
  --primary-dark: #128c7e;
  --secondary: #667eea;
  --danger: #ff4757;
  --warning: #ffa502;
  --dark: #1a1a2e;
  --darker: #16213e;
  --light: #f8f9fa;
  --card-bg: #ffffff;
  --text: #333333;
  --text-muted: #6c757d;
  --shadow: 0 10px 40px rgba(0,0,0,0.1);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] {
  --card-bg: #1e1e2e;
  --light: #0f0f1a;
  --text: #e0e0e0;
  --text-muted: #a0a0a0;
  --shadow: 0 10px 40px rgba(0,0,0,0.3);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Tajawal', sans-serif;
  background: var(--light);
  color: var(--text);
  min-height: 100vh;
  transition: var(--transition);
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--secondary) 0%, #764ba2 50%, var(--primary-dark) 100%);
  padding: 30px 20px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
  animation: pulse 15s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.header h1 {
  color: white;
  font-size: 2.5rem;
  font-weight: 800;
  text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 15px;
}

.header h1 i {
  font-size: 2rem;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.stats-bar {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.stat-item {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 15px 30px;
  border-radius: 50px;
  color: white;
  display: flex;
  align-items: center;
  gap: 10px;
}

.stat-item i { font-size: 1.5rem; }
.stat-number { font-size: 1.5rem; font-weight: 700; }

/* Theme Toggle */
.theme-toggle {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: var(--card-bg);
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  transition: var(--transition);
}

.theme-toggle:hover { transform: rotate(180deg); }

/* Container */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 30px 20px;
}

/* Add Form */
.add-form-container {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--shadow);
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  cursor: pointer;
}

.form-header h2 {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--primary-dark);
}

.form-header .toggle-icon {
  transition: var(--transition);
}

.form-header.collapsed .toggle-icon {
  transform: rotate(180deg);
}

.add-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  overflow: hidden;
  transition: var(--transition);
}

.add-form.hidden {
  max-height: 0;
  opacity: 0;
  padding: 0;
  margin: 0;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 600;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.form-group input,
.form-group select {
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  font-size: 1rem;
  font-family: inherit;
  background: var(--card-bg);
  color: var(--text);
  transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
}

.form-group input.error {
  border-color: var(--danger);
  animation: shake 0.5s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.image-upload {
  border: 2px dashed #ccc;
  border-radius: 12px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.image-upload:hover {
  border-color: var(--primary);
  background: rgba(37, 211, 102, 0.05);
}

.image-upload input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.image-upload i { font-size: 2rem; color: var(--text-muted); }
.image-upload p { margin-top: 10px; color: var(--text-muted); }

.image-preview {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 10px;
  margin-top: 10px;
}

.submit-btn {
  grid-column: 1 / -1;
  padding: 18px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.submit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(37, 211, 102, 0.3);
}

.submit-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.submit-btn .spinner {
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Search & Filter */
.search-filter-bar {
  display: flex;
  gap: 15px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 300px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 18px 50px 18px 20px;
  border: none;
  border-radius: 15px;
  font-size: 1rem;
  background: var(--card-bg);
  box-shadow: var(--shadow);
  color: var(--text);
  transition: var(--transition);
}

.search-box input:focus {
  outline: none;
  box-shadow: var(--shadow), 0 0 0 3px rgba(37, 211, 102, 0.2);
}

.search-box i {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.sort-select {
  padding: 18px 25px;
  border: none;
  border-radius: 15px;
  font-size: 1rem;
  background: var(--card-bg);
  box-shadow: var(--shadow);
  color: var(--text);
  cursor: pointer;
  font-family: inherit;
}

.filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.filter-btn {
  padding: 12px 25px;
  border-radius: 50px;
  border: 2px solid transparent;
  background: var(--card-bg);
  color: var(--text);
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.filter-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.filter-btn.active {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
}

.filter-btn .count {
  background: rgba(255,255,255,0.2);
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 0.8rem;
}

/* Groups Grid */
.groups-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 25px;
}

.group-card {
  background: var(--card-bg);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: var(--transition);
  animation: fadeInUp 0.5s ease forwards;
  opacity: 0;
  position: relative;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.group-card:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: 0 20px 50px rgba(0,0,0,0.15);
}

.group-image-container {
  height: 200px;
  background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-dark) 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.group-image-container::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.5) 100%);
}

.group-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: var(--transition);
}

.group-card:hover .group-image {
  transform: scale(1.1);
}

.group-image-placeholder {
  font-size: 4rem;
  color: rgba(255,255,255,0.5);
}

.category-badge {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255,255,255,0.9);
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--primary-dark);
  display: flex;
  align-items: center;
  gap: 5px;
}

.favorite-btn {
  position: absolute;
  top: 15px;
  left: 15px;
  background: rgba(255,255,255,0.9);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.favorite-btn:hover { transform: scale(1.1); }
.favorite-btn.active { background: var(--danger); color: white; }
.favorite-btn.active i { animation: heartbeat 0.5s; }

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.3); }
}

.group-content {
  padding: 20px;
}

.group-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 10px;
  color: var(--text);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.group-meta {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.meta-item i { color: var(--primary); }

.group-actions {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.action-btn {
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 0.95rem;
}

.action-btn:hover { transform: translateY(-2px); }

.join-btn {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
}

.join-btn:hover { box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3); }

.copy-btn {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
}

.share-btn {
  background: linear-gradient(135deg, #6f42c1 0%, #4a148c 100%);
  color: white;
}

.delete-btn {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
  color: white;
}

/* No Groups */
.no-groups {
  grid-column: 1 / -1;
  text-align: center;
  padding: 60px 20px;
  background: var(--card-bg);
  border-radius: 20px;
  box-shadow: var(--shadow);
}

.no-groups i {
  font-size: 5rem;
  color: var(--text-muted);
  opacity: 0.3;
  margin-bottom: 20px;
}

.no-groups h3 {
  font-size: 1.5rem;
  color: var(--text);
  margin-bottom: 10px;
}

.no-groups p { color: var(--text-muted); }

/* Toast Notification */
.toast-container {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  background: var(--card-bg);
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideUp 0.3s ease;
  min-width: 300px;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.toast.success { border-right: 4px solid var(--primary); }
.toast.error { border-right: 4px solid var(--danger); }
.toast.warning { border-right: 4px solid var(--warning); }

.toast i { font-size: 1.3rem; }
.toast.success i { color: var(--primary); }
.toast.error i { color: var(--danger); }
.toast.warning i { color: var(--warning); }

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.loading-overlay.active {
  opacity: 1;
  visibility: visible;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(255,255,255,0.2);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
  padding: 20px;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 30px;
  max-width: 400px;
  width: 100%;
  transform: scale(0.9);
  transition: var(--transition);
  text-align: center;
}

.modal-overlay.active .modal {
  transform: scale(1);
}

.modal h3 {
  margin-bottom: 15px;
  color: var(--text);
}

.modal p {
  color: var(--text-muted);
  margin-bottom: 20px;
}

.modal-input {
  width: 100%;
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 1rem;
  text-align: center;
}

.modal-actions {
  display: flex;
  gap: 10px;
}

.modal-actions button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.modal-actions .confirm-btn {
  background: var(--danger);
  color: white;
}

.modal-actions .cancel-btn {
  background: #e0e0e0;
  color: var(--text);
}

/* Scroll to top */
.scroll-top {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
  box-shadow: 0 5px 20px rgba(37, 211, 102, 0.3);
}

.scroll-top.visible {
  opacity: 1;
  visibility: visible;
}

.scroll-top:hover {
  transform: translateY(-5px);
}

/* Responsive */
@media (max-width: 768px) {
  .header h1 { font-size: 1.8rem; }
  .stats-bar { gap: 15px; }
  .stat-item { padding: 10px 20px; }
  .search-box { min-width: 100%; }
  .groups-grid { grid-template-columns: 1fr; }
  .add-form { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<!-- Theme Toggle -->
<button class="theme-toggle" onclick="toggleTheme()">
  <i class="fas fa-moon"></i>
</button>

<!-- Header -->
<header class="header">
  <h1>
    <i class="fab fa-whatsapp"></i>
    قروبات واتساب
  </h1>
  <div class="stats-bar">
    <div class="stat-item">
      <i class="fas fa-users"></i>
      <span>عدد القروبات:</span>
      <span class="stat-number" id="groupCount">0</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-heart"></i>
      <span>المفضلة:</span>
      <span class="stat-number" id="favCount">0</span>
    </div>
  </div>
</header>

<div class="container">
  <!-- Add Form -->
  <div class="add-form-container">
    <div class="form-header" onclick="toggleForm()">
      <h2>
        <i class="fas fa-plus-circle"></i>
        إضافة قروب جديد
      </h2>
      <i class="fas fa-chevron-up toggle-icon"></i>
    </div>

    <form class="add-form" id="groupForm">
      <div class="form-group">
        <label><i class="fas fa-signature"></i> اسم القروب</label>
        <input type="text" id="groupName" placeholder="أدخل اسم القروب" required>
      </div>

      <div class="form-group">
        <label><i class="fas fa-link"></i> رابط القروب</label>
        <input type="url" id="groupLink" placeholder="https://chat.whatsapp.com/..." required>
      </div>

      <div class="form-group">
        <label><i class="fas fa-users"></i> عدد الأعضاء</label>
        <input type="number" id="groupMembers" placeholder="عدد الأعضاء" min="1" required>
      </div>

      <div class="form-group">
        <label><i class="fas fa-folder"></i> التصنيف</label>
        <select id="groupCategory" required>
          <option value="">اختر التصنيف</option>
          <option value="general">عام</option>
          <option value="games">ألعاب</option>
          <option value="study">دراسة</option>
          <option value="tech">تقنية</option>
          <option value="sports">رياضة</option>
          <option value="news">أخبار</option>
          <option value="entertainment">ترفيه</option>
          <option value="business">أعمال</option>
          <option value="other">أخرى</option>
        </select>
      </div>

      <div class="form-group" style="grid-column: 1 / -1;">
        <label><i class="fas fa-image"></i> صورة القروب (اختياري)</label>
        <div class="image-upload" id="imageUpload">
          <input type="file" id="groupImage" accept="image/*" onchange="previewImage(this)">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>اضغط أو اسحب الصورة هنا</p>
          <img id="imagePreview" class="image-preview" style="display: none;">
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">
        <i class="fas fa-plus"></i>
        إضافة القروب
      </button>
    </form>
  </div>

  <!-- Search & Filter -->
  <div class="search-filter-bar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ابحث عن قروب...">
      <i class="fas fa-search"></i>
    </div>
    <select class="sort-select" id="sortSelect" onchange="applyFilters()">
      <option value="newest">الأحدث أولاً</option>
      <option value="oldest">الأقدم أولاً</option>
      <option value="members-high">الأكثر أعضاء</option>
      <option value="members-low">الأقل أعضاء</option>
      <option value="name">أبجدياً</option>
    </select>
  </div>

  <div class="filters" id="filtersContainer">
    <button class="filter-btn active" data-filter="all">
      <i class="fas fa-globe"></i> الكل
      <span class="count" id="count-all">0</span>
    </button>
    <button class="filter-btn" data-filter="favorites">
      <i class="fas fa-heart"></i> المفضلة
      <span class="count" id="count-favorites">0</span>
    </button>
    <button class="filter-btn" data-filter="general">
      <i class="fas fa-comments"></i> عام
    </button>
    <button class="filter-btn" data-filter="games">
      <i class="fas fa-gamepad"></i> ألعاب
    </button>
    <button class="filter-btn" data-filter="study">
      <i class="fas fa-graduation-cap"></i> دراسة
    </button>
    <button class="filter-btn" data-filter="tech">
      <i class="fas fa-laptop-code"></i> تقنية
    </button>
    <button class="filter-btn" data-filter="sports">
      <i class="fas fa-futbol"></i> رياضة
    </button>
    <button class="filter-btn" data-filter="entertainment">
      <i class="fas fa-film"></i> ترفيه
    </button>
  </div>

  <!-- Groups Grid -->
  <div class="groups-grid" id="groupsList"></div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Delete Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
    <h3>تأكيد الحذف</h3>
    <p>هل أنت متأكد من حذف هذا القروب؟</p>
    <input type="password" class="modal-input" id="adminPassword" placeholder="أدخل كلمة سر الأدمن" style="display: none;">
    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeDeleteModal()">إلغاء</button>
      <button class="confirm-btn" onclick="confirmDelete()">حذف</button>
    </div>
  </div>
</div>

<!-- Scroll to Top -->
<button class="scroll-top" id="scrollTop" onclick="scrollToTop()">
  <i class="fas fa-arrow-up"></i>
</button>

<script>
// =============================
// Configuration & State
// =============================
const ADMIN_PASSWORD = "96638223";
let allGroups = {};
let currentFilter = 'all';
let pendingDeleteId = null;
let pendingDeleteOwnerId = null;

// User & Admin
if (!localStorage.getItem("userId")) {
  localStorage.setItem("userId", "user_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9));
}
const currentUser = localStorage.getItem("userId");
let isAdmin = localStorage.getItem("isAdmin") === "true";

// Favorites
let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");

// Theme
const savedTheme = localStorage.getItem("theme") || "light";
document.documentElement.setAttribute("data-theme", savedTheme);
updateThemeIcon();

// =============================
// Firebase
// =============================
const firebaseConfig = {
  apiKey: "AIzaSyCEEWOwJJPhRcd7tN00WYpkhMMqG9GKXhw",
  authDomain: "whatsapp-group-7f4ec.firebaseapp.com",
  databaseURL: "https://whatsapp-group-7f4ec-default-rtdb.firebaseio.com",
  projectId: "whatsapp-group-7f4ec",
  storageBucket: "whatsapp-group-7f4ec.firebasestorage.app",
  messagingSenderId: "12281639708",
  appId: "1:12281639708:web:a3d2a1e0d02a7f647240d9"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// =============================
// Theme
// =============================
function toggleTheme() {
  const current = document.documentElement.getAttribute("data-theme");
  const newTheme = current === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  updateThemeIcon();
}

function updateThemeIcon() {
  const icon = document.querySelector(".theme-toggle i");
  const theme = document.documentElement.getAttribute("data-theme");
  icon.className = theme === "dark" ? "fas fa-sun" : "fas fa-moon";
}

// =============================
// Toast Notifications
// =============================
function showToast(message, type = "success") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;

  const icons = {
    success: "fa-check-circle",
    error: "fa-times-circle",
    warning: "fa-exclamation-circle"
  };

  toast.innerHTML = `
    <i class="fas ${icons[type]}"></i>
    <span>${message}</span>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(20px)";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// =============================
// Form
// =============================
function toggleForm() {
  const form = document.querySelector(".add-form");
  const header = document.querySelector(".form-header");
  form.classList.toggle("hidden");
  header.classList.toggle("collapsed");
}

function previewImage(input) {
  const preview = document.getElementById("imagePreview");
  const uploadArea = document.getElementById("imageUpload");

  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = "block";
      uploadArea.querySelector("i").style.display = "none";
      uploadArea.querySelector("p").style.display = "none";
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function validateWhatsAppLink(link) {
  const pattern = /^https:\/\/chat\.whatsapp\.com\/[A-Za-z0-9]+$/;
  return pattern.test(link);
}

function compressImage(file, maxWidth = 800) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement("canvas");
        const ratio = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * ratio;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        resolve(canvas.toDataURL("image/jpeg", 0.7));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// Form Submit
document.getElementById("groupForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const name = document.getElementById("groupName").value.trim();
  const link = document.getElementById("groupLink").value.trim();
  const members = parseInt(document.getElementById("groupMembers").value);
  const category = document.getElementById("groupCategory").value;
  const imageFile = document.getElementById("groupImage").files[0];

  // Validation
  if (!name || name.length < 3) {
    document.getElementById("groupName").classList.add("error");
    showToast("اسم القروب يجب أن يكون 3 أحرف على الأقل", "error");
    return;
  }

  if (!validateWhatsAppLink(link)) {
    document.getElementById("groupLink").classList.add("error");
    showToast("الرجاء إدخال رابط واتساب صحيح", "error");
    return;
  }

  if (!category) {
    showToast("الرجاء اختيار التصنيف", "error");
    return;
  }

  // Show loading
  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> جاري الإضافة...';

  try {
    const newGroupRef = database.ref('groups').push();

    let imageData = null;
    if (imageFile) {
      imageData = await compressImage(imageFile);
    }

    await newGroupRef.set({
      name,
      link,
      members,
      category,
      image: imageData,
      ownerId: currentUser,
      createdAt: Date.now()
    });

    showToast("تم إضافة القروب بنجاح!", "success");
    this.reset();
    document.getElementById("imagePreview").style.display = "none";
    document.getElementById("imageUpload").querySelector("i").style.display = "block";
    document.getElementById("imageUpload").querySelector("p").style.display = "block";

  } catch (error) {
    showToast("حدث خطأ أثناء الإضافة", "error");
  }

  btn.disabled = false;
  btn.innerHTML = '<i class="fas fa-plus"></i> إضافة القروب';
});

// Remove error class on input
document.querySelectorAll(".form-group input").forEach(input => {
  input.addEventListener("input", () => input.classList.remove("error"));
});

// =============================
// Groups Display
// =============================
database.ref('groups').on('value', function(snapshot) {
  allGroups = snapshot.val() || {};
  applyFilters();
  updateStats();
});

function updateStats() {
  const count = Object.keys(allGroups).length;
  document.getElementById("groupCount").textContent = count;
  document.getElementById("count-all").textContent = count;
  document.getElementById("favCount").textContent = favorites.length;
  document.getElementById("count-favorites").textContent = favorites.length;
}

function getCategoryIcon(category) {
  const icons = {
    general: "fa-comments",
    games: "fa-gamepad",
    study: "fa-graduation-cap",
    tech: "fa-laptop-code",
    sports: "fa-futbol",
    news: "fa-newspaper",
    entertainment: "fa-film",
    business: "fa-briefcase",
    other: "fa-folder"
  };
  return icons[category] || "fa-folder";
}

function getCategoryName(category) {
  const names = {
    general: "عام",
    games: "ألعاب",
    study: "دراسة",
    tech: "تقنية",
    sports: "رياضة",
    news: "أخبار",
    entertainment: "ترفيه",
    business: "أعمال",
    other: "أخرى"
  };
  return names[category] || category;
}

function formatDate(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return "الآن";
  if (diff < 3600000) return `منذ ${Math.floor(diff/60000)} دقيقة`;
  if (diff < 86400000) return `منذ ${Math.floor(diff/3600000)} ساعة`;
  if (diff < 604800000) return `منذ ${Math.floor(diff/86400000)} يوم`;

  return date.toLocaleDateString("ar-SA");
}

function applyFilters() {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const sortValue = document.getElementById("sortSelect").value;

  let filtered = Object.entries(allGroups);

  // Category filter
  if (currentFilter === "favorites") {
    filtered = filtered.filter(([key]) => favorites.includes(key));
  } else if (currentFilter !== "all") {
    filtered = filtered.filter(([, g]) => g.category === currentFilter);
  }

  // Search filter
  if (searchTerm) {
    filtered = filtered.filter(([, g]) =>
      g.name.toLowerCase().includes(searchTerm)
    );
  }

  // Sort
  switch(sortValue) {
    case "newest":
      filtered.sort((a, b) => b[1].createdAt - a[1].createdAt);
      break;
    case "oldest":
      filtered.sort((a, b) => a[1].createdAt - b[1].createdAt);
      break;
    case "members-high":
      filtered.sort((a, b) => b[1].members - a[1].members);
      break;
    case "members-low":
      filtered.sort((a, b) => a[1].members - b[1].members);
      break;
    case "name":
      filtered.sort((a, b) => a[1].name.localeCompare(b[1].name, "ar"));
      break;
  }

  renderGroups(filtered);
}

function renderGroups(groups) {
  const container = document.getElementById("groupsList");
  container.innerHTML = "";

  if (groups.length === 0) {
    container.innerHTML = `
      <div class="no-groups">
        <i class="fas fa-search"></i>
        <h3>لا توجد نتائج</h3>
        <p>جرب تغيير معايير البحث أو الفلترة</p>
      </div>
    `;
    return;
  }

  groups.forEach(([key, g], index) => {
    const isFavorite = favorites.includes(key);
    const canDelete = g.ownerId === currentUser || isAdmin;

    const card = document.createElement("div");
    card.className = "group-card";
    card.style.animationDelay = `${index * 0.05}s`;

    card.innerHTML = `
      <div class="group-image-container">
        ${g.image
          ? `<img src="${g.image}" class="group-image" loading="lazy">`
          : `<i class="fas fa-users group-image-placeholder"></i>`
        }
        <span class="category-badge">
          <i class="fas ${getCategoryIcon(g.category)}"></i>
          ${getCategoryName(g.category)}
        </span>
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${key}')">
          <i class="fas fa-heart"></i>
        </button>
      </div>

      <div class="group-content">
        <h3 class="group-title">${escapeHtml(g.name)}</h3>

        <div class="group-meta">
          <span class="meta-item">
            <i class="fas fa-users"></i>
            ${g.members} عضو
          </span>
          <span class="meta-item">
            <i class="fas fa-clock"></i>
            ${formatDate(g.createdAt)}
          </span>
        </div>

        <div class="group-actions">
          <a href="${g.link}" target="_blank" class="action-btn join-btn">
            <i class="fab fa-whatsapp"></i>
            انضم الآن
          </a>
          <button class="action-btn copy-btn" onclick="copyLink('${g.link}')">
            <i class="fas fa-copy"></i>
            نسخ
          </button>
          <button class="action-btn share-btn" onclick="shareGroup('${escapeHtml(g.name)}', '${g.link}')">
            <i class="fas fa-share-alt"></i>
            مشاركة
          </button>
          ${canDelete ? `
            <button class="action-btn delete-btn" onclick="attemptDelete('${key}', '${g.ownerId}')">
              <i class="fas fa-trash"></i>
              حذف
            </button>
          ` : ''}
        </div>
      </div>
    `;

    container.appendChild(card);
  });
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

// =============================
// Actions
// =============================
function copyLink(link) {
  navigator.clipboard.writeText(link);
  showToast("تم نسخ رابط القروب", "success");
}

function shareGroup(name, link) {
  if (navigator.share) {
    navigator.share({
      title: name,
      text: `انضم إلى قروب ${name}`,
      url: link
    });
  } else {
    copyLink(link);
    showToast("تم نسخ الرابط للمشاركة", "success");
  }
}

function toggleFavorite(groupId) {
  const index = favorites.indexOf(groupId);
  if (index > -1) {
    favorites.splice(index, 1);
    showToast("تم إزالة القروب من المفضلة", "warning");
  } else {
    favorites.push(groupId);
    showToast("تم إضافة القروب للمفضلة", "success");
  }
  localStorage.setItem("favorites", JSON.stringify(favorites));
  updateStats();
  applyFilters();
}

// =============================
// Delete
// =============================
function attemptDelete(groupId, ownerId) {
  pendingDeleteId = groupId;
  pendingDeleteOwnerId = ownerId;

  const modal = document.getElementById("deleteModal");
  const passwordInput = document.getElementById("adminPassword");

  if (ownerId === currentUser || isAdmin) {
    passwordInput.style.display = "none";
  } else {
    passwordInput.style.display = "block";
    passwordInput.value = "";
  }

  modal.classList.add("active");
}

function closeDeleteModal() {
  document.getElementById("deleteModal").classList.remove("active");
  pendingDeleteId = null;
  pendingDeleteOwnerId = null;
}

function confirmDelete() {
  if (!pendingDeleteId) return;

  const passwordInput = document.getElementById("adminPassword");

  if (pendingDeleteOwnerId !== currentUser && !isAdmin) {
    if (passwordInput.value !== ADMIN_PASSWORD) {
      showToast("كلمة السر غير صحيحة", "error");
      return;
    }
    isAdmin = true;
    localStorage.setItem("isAdmin", "true");
  }

  database.ref('groups/' + pendingDeleteId).remove()
    .then(() => {
      showToast("تم حذف القروب بنجاح", "success");
      // Remove from favorites if exists
      const favIndex = favorites.indexOf(pendingDeleteId);
      if (favIndex > -1) {
        favorites.splice(favIndex, 1);
        localStorage.setItem("favorites", JSON.stringify(favorites));
      }
    })
    .catch(() => {
      showToast("حدث خطأ أثناء الحذف", "error");
    });

  closeDeleteModal();
}

// =============================
// Filter Buttons
// =============================
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
    currentFilter = this.getAttribute("data-filter");
    localStorage.setItem("lastFilter", currentFilter);
    applyFilters();
  });
});

// =============================
// Search
// =============================
document.getElementById("searchInput").addEventListener("input", function() {
  localStorage.setItem("lastSearch", this.value);
  applyFilters();
});

// =============================
// Scroll to Top
// =============================
window.addEventListener("scroll", function() {
  const btn = document.getElementById("scrollTop");
  if (window.scrollY > 300) {
    btn.classList.add("visible");
  } else {
    btn.classList.remove("visible");
  }
});

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// =============================
// Restore State
// =============================
window.onload = function() {
  const lastSearch = localStorage.getItem("lastSearch");
  const lastFilter = localStorage.getItem("lastFilter");

  if (lastSearch) {
    document.getElementById("searchInput").value = lastSearch;
  }

  if (lastFilter) {
    const filterBtn = document.querySelector(`[data-filter="${lastFilter}"]`);
    if (filterBtn) {
      document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
      filterBtn.classList.add("active");
      currentFilter = lastFilter;
    }
  }
};

// Close modal on outside click
document.getElementById("deleteModal").addEventListener("click", function(e) {
  if (e.target === this) closeDeleteModal();
});
</script>

</body>
</html>
